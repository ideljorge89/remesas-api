{% extends 'base_backend.html.twig' %}
{% trans_default_domain 'AppBundle' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('assets/backend/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css') }}"
          rel="stylesheet">
    <link href="{{ asset('assets/comun/jquery/leaflet/leaflet.css') }}" rel="stylesheet">
    <link href="{{ asset('assets/comun/jquery/leaflet/plugins/full-screen/Control.FullScreen.css') }}" rel="stylesheet">
    <link href="{{ asset('assets/comun/jquery/leaflet/plugins/locate/L.Control.Locate.min.css') }}" rel="stylesheet">
    <style type="text/css">
        /*.leaflet-popup-content-wrapper {
            background-color: #f6f6f4;
        }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #f6f6f4 none repeat scroll 0 0;
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
        }*/
    </style>
{% endblock %}
{% block breadcrumb_content %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <!-- Flot -->
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.tooltip.min.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.spline.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.resize.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.pie.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/jquery.flot.symbol.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/flot/curvedLines.js') }}"></script>
    <!-- ChartJS-->
    <script src="{{ asset('assets/backend/js/plugins/chartJs/Chart.min.js') }}"></script>
    <!-- JVECTORMAP -->
    <script src="{{ asset('assets/backend/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js') }}"></script>
    <script src="{{ asset('assets/backend/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js') }}"></script>
    <script src="{{ asset('assets/comun/jquery/leaflet/leaflet.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/comun/jquery/leaflet/plugins/full-screen/Control.FullScreen.js') }}"
            type="text/javascript"></script>
    <script src="{{ asset('assets/comun/jquery/leaflet/plugins/migration-layer/leaflet.migrationLayer.js') }}"
            type="text/javascript"></script>
    <script src="{{ asset('assets/comun/jquery/leaflet/plugins/locate/L.Control.Locate.min.js') }}"
            type="text/javascript"></script>
    <script type="application/javascript">
        $(function () {

            var bigMap;
            var global_markers = new Array();

            function initBigMap(element, lat, lon, zoom) {
                var mapCenter = [lat, lon];
                var map = L.map(element, {
                    fullscreenControl: true,
                    fullscreenControlOptions: {
                        position: 'topleft'
                    },
                    center: mapCenter, zoom: zoom
                });

                map.scrollWheelZoom.disable();

                map.on('click', function () {
                    if (map.scrollWheelZoom.enabled()) {
                        map.scrollWheelZoom.disable();
                    }
                    else {
                        map.scrollWheelZoom.enable();
                    }
                });
                // load a tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 20,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                bigMap = map;
            }

            function centerMap(lat, lon, zoom) {
                bigMap.setView([lat, lon], zoom)
            }

            function getLocalizations() {
                $.ajax({
                    url: '{{ path('homepage_backend_provincias_ajax') }}',
                    type: 'json',
                    'success': function (data) {
                        for (marker in global_markers) {
                            bigMap.removeLayer(global_markers[marker])
                        }
                        global_markers = new Array();
                        for (localization in data) {
                            if (data[localization]['latitud'] != null && data[localization]['longitud']) {
                                var mark = [data[localization]['latitud'], data[localization]['longitud']]
                                var marker = L.marker(mark)
                                marker.url = data[localization]['url']

                                marker.on('click', function (e) {
                                    if (e.target._latlng && e.target.url) {
                                        var target = e.target

                                        target.bindPopup("Espere ...");

                                        $.ajax({
                                            url: target.url
                                        })
                                            .done(function (data) {
                                                target.bindPopup(data).openPopup();
                                                //target.bindPopup( target._latlng.lat+' --- '+target._latlng.lng ).openPopup();
                                                centerMap(target._latlng.lat, target._latlng.lng)
                                            })
                                            .fail(function (data) {
                                                target.bindPopup("No se pudo cargar la repuesta").openPopup();
                                            });
                                    }
                                });
                                global_markers.push(marker.addTo(bigMap));
                            }

                        }
                    },
                    'failure': function () {

                    }
                })
            }

            var migrationLayer = null;

            if (typeof L != "undefined") {
                initBigMap('map_provincias', 21.442526154832, -79.501227164268, 7);
                getLocalizations();
            }
            dataLink()

            $('.collapse-link').click(function () {
                var ibox = $(this).closest('div.ibox');
                var button = $(this).find('i');
                var content = ibox.find('div.ibox-content');
                content.slideToggle(200);
                button.toggleClass('fa-chevron-up').toggleClass('fa-chevron-down');
                ibox.toggleClass('').toggleClass('border-bottom');
                setTimeout(function () {
                    ibox.resize();
                    ibox.find('[id^=map-]').resize();
                }, 50);
            });
        })
    </script>
{% endblock %}

{% block body %}
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-lg-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-success pull-right">Todas</span>
                        <h5>Total Remesas</h5>
                    </div>
                    <div class="ibox-content">
                        <h3 class="no-margins">{{ totalRemesas }} - CUC</h3>
                        <h3 class="no-margins">{{ totalRemesasCUP }} - CUP</h3>
                        <h3 class="no-margins">{{ totalRemesasUSD }} - USD</h3>
                        <h3 class="no-margins">{{ totalRemesasEUR }} - EUR</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-info pull-right">Hoy</span>
                        <h5>Total Remesas</h5>
                    </div>
                    <div class="ibox-content">
                        <h3 class="no-margins">{{ totalRemesasHoy }} - CUC</h3>
                        <h3 class="no-margins">{{ totalRemesasHoyCUP }} - CUP</h3>
                        <h3 class="no-margins">{{ totalRemesasHoyUSD }} - USD</h3>
                        <h3 class="no-margins">{{ totalRemesasHoyEUR }} - EUR</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-primary pull-right">Todas</span>
                        <h5>Enviado</h5>
                    </div>
                    <div class="ibox-content">
                        <h3 class="no-margins">{{ montoTotalRemesas | number_format(2, '.', ',') }} CUC</h3>
                        <h3 class="no-margins">{{ montoTotalRemesasCUP | number_format(2, '.', ',') }} CUP</h3>
                        <h3 class="no-margins">{{ montoTotalRemesasUSD | number_format(2, '.', ',') }} USD</h3>
                        <h3 class="no-margins">{{ montoTotalRemesasEUR | number_format(2, '.', ',') }} EUR</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-danger pull-right">Hoy</span>
                        <h5>Enviado</h5>
                    </div>
                    <div class="ibox-content">
                        <h3 class="no-margins">{{ montoRemesasHoy | number_format(2, '.', ',') }} CUC</h3>
                        <h3 class="no-margins">{{ montoRemesasHoyCUP | number_format(2, '.', ',') }} CUP</h3>
                        <h3 class="no-margins">{{ montoRemesasHoyUSD | number_format(2, '.', ',') }} USD</h3>
                        <h3 class="no-margins">{{ montoRemesasHoyEUR | number_format(2, '.', ',') }} EUR</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>Distribución por provincias</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="row">
                            <div class="col-md-12">
                                <div id='actions'>
                                    <a href='#' class="btn btn-primary geolocate"><i
                                                class="fa fa-map-marker"></i></a>
                                </div>
                                <div id="map_provincias" style="width: 100%;height: 500px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
